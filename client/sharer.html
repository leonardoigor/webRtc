<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Sharer - Compartilhar Tela</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .user-setup {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        .user-setup input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            margin: 0 10px;
            width: 200px;
        }
        .user-setup button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .user-setup button:hover {
            background: #0056b3;
        }
        .user-setup button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.streaming {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .video-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .video-wrapper {
            display: inline-block;
            margin: 10px;
        }
        video {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #000;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .start-btn {
            background: #28a745;
        }
        .start-btn:hover {
            background: #218838;
        }
        .stop-btn {
            background: #dc3545;
        }
        .stop-btn:hover {
            background: #c82333;
        }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            text-align: center;
        }
        .user-info h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .user-id {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        .recordings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .recordings h3 {
            margin-top: 0;
            color: #495057;
        }
        .recording-item {
            display: inline-block;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .recording-item:hover {
            background: #0056b3;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è WebRTC Sharer - Compartilhar Tela</h1>
        
        <div id="userSetup" class="user-setup">
            <h3>üë§ Identifica√ß√£o do Usu√°rio</h3>
            <p>Digite seu ID para come√ßar a compartilhar:</p>
            <input type="text" id="userIdInput" placeholder="Digite seu ID (ex: usuario123)" maxlength="50">
            <button onclick="registerUser()">üöÄ Entrar</button>
        </div>
        
        <div id="mainInterface" class="hidden">
            <div class="user-info">
                <h3>üë§ Usu√°rio Conectado</h3>
                <div class="user-id" id="currentUserId"></div>
            </div>
            
            <div id="status" class="status disconnected">Desconectado</div>
            
            <div class="video-container">
                <div class="video-wrapper">
                    <h3>üñ•Ô∏è Sua Tela</h3>
                    <video id="localVideo" autoplay muted width="640" height="480"></video>
                </div>
            </div>
            
            <div class="controls">
                <button id="startBtn" class="start-btn" onclick="startStream()" disabled>üñ•Ô∏è Compartilhar Tela</button>
                <button id="stopBtn" class="stop-btn" onclick="stopStream()" disabled>‚èπÔ∏è Parar Compartilhamento</button>
                <button onclick="refreshRecordings()">üîÑ Atualizar Grava√ß√µes</button>
                <button onclick="logout()">üö™ Sair</button>
            </div>
            
            <div class="recordings">
                <h3>üìÅ Suas Grava√ß√µes</h3>
                <div id="recordings">Carregando...</div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl('http://localhost:5000/webrtchub')
            .withAutomaticReconnect()
            .build();

        // Vari√°veis globais
        let localStream;
        let peerConnection;
        let isStreaming = false;
        let isConnected = false;
        let currentUserId = null;

        // Elementos DOM
        const userSetupEl = document.getElementById('userSetup');
        const mainInterfaceEl = document.getElementById('mainInterface');
        const userIdInputEl = document.getElementById('userIdInput');
        const currentUserIdEl = document.getElementById('currentUserId');
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const localVideo = document.getElementById('localVideo');
        const recordingsEl = document.getElementById('recordings');

        // Configura√ß√£o WebRTC
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Registrar usu√°rio
        async function registerUser() {
            const userId = userIdInputEl.value.trim();
            
            if (!userId) {
                alert('Por favor, digite um ID de usu√°rio');
                return;
            }
            
            if (userId.length < 3) {
                alert('O ID deve ter pelo menos 3 caracteres');
                return;
            }
            
            currentUserId = userId;
            currentUserIdEl.textContent = userId;
            
            // Esconder setup e mostrar interface principal
            userSetupEl.classList.add('hidden');
            mainInterfaceEl.classList.remove('hidden');
            
            // Inicializar conex√£o
            await initializeConnection();
        }

        // Sair/Logout
        function logout() {
            if (isStreaming) {
                stopStream();
            }
            
            if (connection.state === 'Connected') {
                connection.stop();
            }
            
            currentUserId = null;
            userIdInputEl.value = '';
            
            // Mostrar setup e esconder interface principal
            userSetupEl.classList.remove('hidden');
            mainInterfaceEl.classList.add('hidden');
            
            updateStatus('disconnected', 'Desconectado');
        }

        // Inicializar conex√£o SignalR
        async function initializeConnection() {
            try {
                await connection.start();
                updateStatus('connected', 'Conectado ao servidor');
                console.log('‚úÖ Conectado ao SignalR Hub');
                
                // Registrar usu√°rio no servidor
                await connection.invoke('RegisterUser', currentUserId);
                console.log(`üë§ Usu√°rio registrado: ${currentUserId}`);
                
                loadRecordings();
            } catch (error) {
                updateStatus('disconnected', 'Erro de conex√£o');
                console.error('‚ùå Erro ao conectar:', error);
                setTimeout(initializeConnection, 5000);
            }
        }

        // Atualizar status da conex√£o
        function updateStatus(type, message) {
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
            isConnected = type === 'connected';
            
            if (type === 'connected') {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }

        // Event listeners do SignalR
        connection.on('ReceiveAnswer', async (answer) => {
            console.log('üì® Recebendo answer');
            if (peerConnection) {
                await peerConnection.setRemoteDescription(answer);
            }
        });

        connection.on('ReceiveIceCandidate', async (candidate) => {
            console.log('üì® Recebendo ICE candidate');
            if (peerConnection) {
                await peerConnection.addIceCandidate(candidate);
            }
        });
        
        connection.on('StreamRequested', async (viewerConnectionId) => {
            console.log('üì∫ Stream solicitado por viewer:', viewerConnectionId);
            if (isStreaming && peerConnection && localStream) {
                try {
                    // Criar oferta usando a conex√£o principal
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await connection.invoke('SendOffer', offer);
                    
                    console.log('‚úÖ Oferta enviada para viewer:', viewerConnectionId);
                } catch (error) {
                    console.error('‚ùå Erro ao criar oferta para viewer:', error);
                }
            }
        });

        connection.onreconnecting(() => {
            updateStatus('disconnected', 'Reconectando...');
        });

        connection.onreconnected(async () => {
            updateStatus('connected', 'Reconectado');
            if (currentUserId) {
                await connection.invoke('RegisterUser', currentUserId);
            }
            loadRecordings();
        });

        connection.onclose(() => {
            updateStatus('disconnected', 'Conex√£o perdida');
        });

        // Iniciar stream
        async function startStream() {
            if (isStreaming || !isConnected || !currentUserId) return;
            
            try {
                console.log('üé¨ Iniciando compartilhamento de tela...');
                updateStatus('streaming', 'Iniciando compartilhamento de tela...');
                
                // Obter compartilhamento de tela
                localStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { width: 1280, height: 720 }, 
                    audio: true 
                });
                localVideo.srcObject = localStream;
                
                // Criar conex√£o WebRTC
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // Adicionar tracks locais
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Configurar event handlers
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üì§ Enviando ICE candidate');
                        connection.invoke('SendIceCandidate', event.candidate);
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    console.log('üîó Estado da conex√£o:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        updateStatus('streaming', `üñ•Ô∏è ${currentUserId} compartilhando tela ao vivo`);
                    }
                };
                
                // Detectar quando o usu√°rio para o compartilhamento pela interface do navegador
                localStream.getVideoTracks()[0].addEventListener('ended', () => {
                    console.log('üõë Compartilhamento parado pelo usu√°rio');
                    stopStream();
                });
                
                // Criar e enviar offer automaticamente para iniciar o compartilhamento
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await connection.invoke('SendOffer', offer);
                
                isStreaming = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                console.log('‚úÖ Stream iniciado com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao iniciar stream:', error);
                updateStatus('connected', 'Erro ao iniciar stream');
                await stopStream();
            }
        }

        // Parar stream
        async function stopStream() {
            if (!isStreaming) return;
            
            try {
                console.log('‚èπÔ∏è Parando stream...');
                
                // Parar tracks locais
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('üõë Track parado:', track.kind);
                    });
                    localVideo.srcObject = null;
                }
                
                // Fechar conex√£o WebRTC
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                
                // Notificar servidor
                if (isConnected) {
                    await connection.invoke('StopStream');
                }
                
                isStreaming = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                updateStatus('connected', 'Compartilhamento parado');
                console.log('‚úÖ Stream parado com sucesso');
                
                // Atualizar lista de grava√ß√µes
                setTimeout(loadRecordings, 1000);
                
            } catch (error) {
                console.error('‚ùå Erro ao parar stream:', error);
            }
        }

        // Carregar grava√ß√µes do usu√°rio atual
        async function loadRecordings() {
            if (!currentUserId) return;
            
            try {
                const response = await fetch('http://localhost:5000/api/recordings');
                const allRecordings = await response.json();
                
                // Filtrar grava√ß√µes do usu√°rio atual
                const userRecordings = allRecordings.filter(recording => 
                    recording.includes(`recording_${currentUserId}_`)
                );
                
                recordingsEl.innerHTML = '';
                
                if (userRecordings.length === 0) {
                    recordingsEl.innerHTML = '<p>Nenhuma grava√ß√£o sua dispon√≠vel</p>';
                    return;
                }
                
                userRecordings.forEach(recording => {
                    const button = document.createElement('button');
                    button.textContent = `‚ñ∂Ô∏è ${recording}`;
                    button.className = 'recording-item';
                    button.onclick = () => playRecording(recording);
                    recordingsEl.appendChild(button);
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar grava√ß√µes:', error);
                recordingsEl.innerHTML = '<p>Erro ao carregar grava√ß√µes</p>';
            }
        }

        // Reproduzir grava√ß√£o
        function playRecording(filename) {
            console.log('‚ñ∂Ô∏è Reproduzindo:', filename);
            const url = `http://localhost:5000/recordings/${filename}`;
            window.open(url, '_blank');
        }

        // Atualizar grava√ß√µes
        function refreshRecordings() {
            console.log('üîÑ Atualizando lista de grava√ß√µes...');
            loadRecordings();
        }

        // Permitir Enter no campo de input
        userIdInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                registerUser();
            }
        });

        // Inicializar aplica√ß√£o
        window.addEventListener('load', () => {
            console.log('üöÄ Inicializando WebRTC Sharer...');
            userIdInputEl.focus();
        });

        // Cleanup ao fechar p√°gina
        window.addEventListener('beforeunload', () => {
            if (isStreaming) {
                stopStream();
            }
        });
    </script>
</body>
</html>